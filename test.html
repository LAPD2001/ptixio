<canvas id="canvasMask"></canvas>
<div id="count"></div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix"></script>

<script>
const video = document.createElement('video');
video.autoplay = true;
video.playsInline = true;
video.muted = true; // για κινητά
video.style.display = 'none'; // το κρύβουμε, δεν χρειάζεται να φανεί
document.body.appendChild(video);

const canvasMask = document.getElementById('canvasMask');
const ctxMask = canvasMask.getContext('2d');
const countDiv = document.getElementById('count');

window.onload = init;

async function init() {
  // Επιλογή: οθόνη ή κάμερα
  const useScreen = confirm("Do you want to share your screen? Press 'Cancel' for the camera.");

  let stream;
  if (useScreen) {
    stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
  } else {
    stream = await navigator.mediaDevices.getUserMedia({ video: true });
  }

  video.srcObject = stream;
  await video.play();

  const net = await bodyPix.load();
  console.log("BodyPix model loaded");

  async function detect() {
    const segmentation = await net.segmentMultiPerson(video, {
      internalResolution: 'medium',
      segmentationThreshold: 0.7
    });

    canvasMask.width = video.videoWidth;
    canvasMask.height = video.videoHeight;
    ctxMask.clearRect(0, 0, canvasMask.width, canvasMask.height);

    const mask = bodyPix.toMask(segmentation);
    bodyPix.drawMask(canvasMask, video, mask, 0.6, 3, false);

    const count = segmentation.length;
    countDiv.textContent = `Number of people: ${count}`;

    requestAnimationFrame(detect);
  }

  detect();
}

document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "hidden") {
    console.log("Η σελίδα είναι κρυφή - σταματάει η ανίχνευση.");
    countDiv.textContent = "Η ανίχνευση σταμάτησε γιατί η σελίδα είναι στο παρασκήνιο.";
  } else {
    console.log("Η σελίδα είναι ξανά ορατή - επανεκκίνηση.");
    countDiv.textContent = "Επανεκκίνηση ανίχνευσης...";
    requestAnimationFrame(detect);
  }
});

</script>
